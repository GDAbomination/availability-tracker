<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edit Availability</title>
<link rel="stylesheet" href="styles.css">
<style>
/* ---------- Page-specific ---------- */
main {
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 24px;
}

h2 {
  font-size: 2rem;
  margin-bottom: 16px;
}

/* Wrapper for header + grid */
.edit-wrapper {
  display: flex;
  flex-direction: column;
  gap: 4px;
  overflow-x: auto;
}

/* Days header */
.days-header {
  display: grid;
  grid-template-columns: repeat(7, 1fr); /* 7 day columns */
  gap: 2px;
  margin-bottom: 4px;
}

.days-header div {
  text-align: center;
  color: #b9b9cc;
  font-size: 0.9rem;
}

/* Time + grid wrapper */
.time-grid-wrapper {
  display: grid;
  grid-template-columns: auto 1fr; /* time labels + main grid */
  gap: 4px;
  align-items: start;
  overflow-x: auto;
}

/* Time labels */
.time-labels {
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.time-labels div {
  height: 22px;       /* each row height */
  line-height: 20px;
  font-size: 0.7rem;
  color: #b9b9cc;
  text-align: right;
  padding-right: 4px;
}

/* Edit grid */
.edit-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
}

/* Each cell stretches to fit the grid row height automatically */
.edit-cell {
  width: 100%;   /* stretch to fill column */
  height: 20px;
  background: #444454;
  border-radius: 2px;
  cursor: pointer;
  transition: background 0.2s;
}

.edit-cell.active {
  background: #6aa6ff; /* selected color */
}
</style>
</head>
<body>

<header>
  <div class="header-title">
    <img src="icon.png" alt="Studio Icon">
    <h1>Echo Frontier</h1>
  </div>
</header>

<nav>
  <a href="index.html">Home</a>
  <a href="members.html">Members</a>
  <a href="availability.html">Availability</a>
</nav>

<main>
  <div class="availability-header">
  <!-- Left: Title -->
    <h2>Edit Availability</h2>

  <!-- Center: Member dropdown -->
    <select id="memberSelect">
      <option value="member0">select...</option>
      <option value="member1">Speedix08</option>
      <option value="member2">GD_Abomination</option>
      <option value="member3">SimLeek</option>
      <option value="member4">Flame</option>
      <option value="member5">Lele</option>
    </select>

  <!-- Right: Save button -->
    <button id="saveButton">Save</button>
  </div>


  <div class="edit-wrapper">
    <!-- Days of the week header -->
    <div class="days-header" id="daysHeader"></div>

    <!-- Time labels + grid -->
    <div class="time-grid-wrapper">
      <div class="time-labels" id="timeLabels"></div>
      <div id="editGrid" class="edit-grid"></div>
    </div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.15.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.15.0/firebase-firestore.js";

// ----- Firebase setup -----
const firebaseConfig = {
  apiKey: "AIzaSyADRD-ZSdmtLAChpCJSg2m-eGD8KkZQLAw",
  authDomain: "echo-frontier.firebaseapp.com",
  projectId: "echo-frontier",
  storageBucket: "echo-frontier.firebasestorage.app",
  messagingSenderId: "483328395754",
  appId: "1:483328395754:web:8426b8abe728f6fd5e0a93"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ----- DOM Elements -----
const hours = 24;
const increments = 2;
const days = 7;

const timeLabelsEl = document.getElementById("timeLabels");
const daysHeaderEl = document.getElementById("daysHeader");
const gridEl = document.getElementById("editGrid");
const memberSelect = document.getElementById("memberSelect");
const saveButton = document.getElementById("saveButton");

const dayNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const cells = [];

// ----- Build header and grid -----

// Days header
for (let d=0; d<days; d++) {
  const div = document.createElement("div");
  div.textContent = dayNames[d];
  daysHeaderEl.appendChild(div);
}

// Time labels
for (let h=0; h<hours; h++) {
  for (let i=0; i<increments; i++) {
    const date = new Date();
    date.setHours(h, i*30, 0, 0);
    const label = document.createElement("div");
    label.textContent = date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    timeLabelsEl.appendChild(label);
  }
}

// Build 7x48 grid
for (let row=0; row<hours*increments; row++) {
  for (let day=0; day<days; day++) {
    const cell = document.createElement("div");
    cell.classList.add("edit-cell");
    cell.dataset.day = day;
    cell.dataset.row = row;
    gridEl.appendChild(cell);
    cells.push(cell);
  }
}

// ----- Click + Drag Logic -----
let isDragging = false;
let dragValue = true;

cells.forEach(cell => {
  cell.addEventListener("mousedown", e => {
    e.preventDefault();
    isDragging = true;
    dragValue = !cell.classList.contains("active");
    setCell(cell, dragValue);
  });
  cell.addEventListener("mouseenter", () => {
    if (isDragging) setCell(cell, dragValue);
  });
});

document.addEventListener("mouseup", () => isDragging = false);

function setCell(cell, value) {
  if (value) cell.classList.add("active");
  else cell.classList.remove("active");
}

// ----- Populate member dropdown from Firestore -----
async function loadMembers() {
  // Member0 is default
  memberSelect.innerHTML = '<option value="member0">Member 0</option>';

  const snapshot = await getDocs(collection(db, "members"));
  snapshot.forEach(docSnap => {
    if (docSnap.id !== "member0") {
      const opt = document.createElement("option");
      opt.value = docSnap.id;
      opt.textContent = docSnap.data().name;
      memberSelect.appendChild(opt);
    }
  });
}
loadMembers();

// ----- Load availability for a member -----
async function loadAvailability(memberId) {
  if (cells.length === 0) {
    console.error("Grid cells not initialized!");
    return;
  }

  // Clear all cells
  cells.forEach(c => c.classList.remove("active"));

  const docSnap = await getDoc(doc(db, "availability", memberId));
  if (!docSnap.exists()) return;
  
  const slots = docSnap.data().slots || {};
  for (const utcStr in slots) {
    const utcDate = new Date(utcStr);
    const localDate = new Date(utcDate.getTime() + utcDate.getTimezoneOffset() * 60000);
    const day = localDate.getDay();
    const hour = localDate.getHours();
    const minute = localDate.getMinutes();
    const row = hour * 2 + (minute >= 30 ? 1 : 0);
    const index = row * days + day;

    if (index < 0 || index >= cells.length) {
      console.warn("Calculated index out of bounds:", index);
      continue;
    }

    cells[index].classList.add("active");
  }
}

// Load default member0 on page load
loadAvailability("member0");

// Change member selection
memberSelect.addEventListener("change", () => {
  loadAvailability(memberSelect.value);
});

// ----- Save availability -----
saveButton.addEventListener("click", async () => {
  const availability = {};
  cells.forEach(cell => {
    if (cell.classList.contains("active")) {
      const day = parseInt(cell.dataset.day);
      const row = parseInt(cell.dataset.row);
      const hour = Math.floor(row / 2);
      const minute = (row % 2) * 30;
      const localDate = new Date();
      localDate.setHours(hour, minute, 0, 0);

      // Adjust to correct day
      const today = new Date();
      const diff = day - today.getDay();
      localDate.setDate(localDate.getDate() + diff);

      // Convert local -> UTC
      const utcDate = new Date(localDate.getTime() - localDate.getTimezoneOffset()*60000);
      availability[utcDate.toISOString()] = true;
    }
  });

  try {
    await setDoc(doc(db, "availability", memberSelect.value), { slots: availability });
    alert("Availability saved successfully!");
  } catch (error) {
    console.error("Error saving availability:", error);
    alert("Error saving availability");
  }
});
</script>

</body>
</html>
