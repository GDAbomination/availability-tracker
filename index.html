<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Team Availability</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0c0c0c;
  color: #eee;
  padding: 16px;
}

h1 { text-align: center; }

.controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 14px;
}

.grid {
  display: grid;
  grid-template-columns: 70px repeat(7, 1fr);
  gap: 1px;
}

.header, .time {
  background: #151515;
  padding: 4px;
  font-size: 12px;
}

.header {
  text-align: center;
  font-weight: bold;
}

.time {
  text-align: right;
}

.cell {
  background: #1e1e1e;
  height: 22px;
  cursor: pointer;
  user-select: none;
}
</style>
</head>

<body>

<h1>Team Availability</h1>

<div class="controls">
  <div id="userInfo"></div>
  <div>
    Timezone:
    <select id="tzSelect"></select>
    &nbsp;
    Share:
    <input id="shareLink" size="28" readonly>
  </div>
</div>

<div class="grid" id="grid"></div>

<script>
/* ---------- CONSTANTS ---------- */
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const ROWS = 48;
const MS_PER_SLOT = 30 * 60 * 1000;

/* ---------- ROOM ---------- */
const params = new URLSearchParams(location.search);
let room = params.get("room");
if (!room) {
  room = Math.random().toString(36).slice(2,8);
  params.set("room", room);
  history.replaceState(null,"","?"+params.toString());
}
document.getElementById("shareLink").value = location.href;

/* ---------- USER ---------- */
let username = localStorage.getItem("username");
if (!username) {
  username = prompt("Enter your name");
  localStorage.setItem("username", username);
}

// Richer deep blue color for the user
const color = "#001F4D"; // very rich deep blue

/* ---------- TIMEZONE ---------- */
let timezone =
  localStorage.getItem("timezone") ||
  Intl.DateTimeFormat().resolvedOptions().timeZone;

const tzSelect = document.getElementById("tzSelect");
Intl.supportedValuesOf("timeZone").forEach(tz => {
  const opt = document.createElement("option");
  opt.value = tz;
  opt.textContent = tz;
  tzSelect.appendChild(opt);
});
tzSelect.value = timezone;

document.getElementById("userInfo").textContent =
  `${username} (${timezone})`;

/* ---------- STORAGE ---------- */
const roomKey = "room_"+room;
let roomData = JSON.parse(localStorage.getItem(roomKey)) || {};
if (!roomData[username]) roomData[username] = {};

function save() {
  localStorage.setItem(roomKey, JSON.stringify(roomData));
}

/* ---------- TIME MODEL ---------- */
let anchorUTC = computeAnchor();

function computeAnchor() {
  const now = new Date();
  const parts = new Intl.DateTimeFormat("en-US", {
    timeZone: timezone,
    year: "numeric",
    month: "numeric",
    day: "numeric"
  }).formatToParts(now);

  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);

  return Date.UTC(y, m - 1, d);
}

/* ---------- GRID MAPPING ---------- */
function gridToSlot(day, row) {
  return Math.floor((anchorUTC + (day * ROWS + row) * MS_PER_SLOT) / MS_PER_SLOT);
}

function rowLabel(row) {
  const d = new Date(anchorUTC + row * MS_PER_SLOT);
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

/* ---------- GRID ---------- */
const grid = document.getElementById("grid");
let isDragging = false;
let dragValue = true;

/* Headers */
grid.appendChild(document.createElement("div"));
DAYS.forEach(d => {
  const h = document.createElement("div");
  h.textContent = d;
  h.className = "header";
  grid.appendChild(h);
});

// Heatmap gradient: gray → deep blue
function heatColor(count, max) {
  if (count === 0) return "#1e1e1e"; // background
  const t = count / max; // 0 → 1
  const r = Math.round(50*(1-t) + 0*t);
  const g = Math.round(50*(1-t) + 51*t);
  const b = Math.round(50*(1-t) + 77*t);
  return `rgb(${r},${g},${b})`;
}

// Store references to cells for drag
let cellRefs = [];

function draw() {
  grid.querySelectorAll(".time,.cell").forEach(e => e.remove());
  cellRefs = [];

  const users = Object.keys(roomData);
  const maxOverlap = users.length || 1;

  for (let r=0; r<ROWS; r++) {
    const t = document.createElement("div");
    t.className = "time";
    t.textContent = rowLabel(r);
    grid.appendChild(t);

    for (let d=0; d<7; d++) {
      const slot = gridToSlot(d, r);
      const c = document.createElement("div");
      c.className = "cell";

      let overlap = 0;
      users.forEach(u => {
        if (roomData[u][slot]) overlap++;
      });

      // User color
      if (roomData[username][slot]) {
        c.style.background = color;
      } else {
        c.style.background = heatColor(overlap, maxOverlap);
      }

      // Add data-slot attribute for global drag
      c.dataset.slot = slot;

      grid.appendChild(c);
      cellRefs.push(c);
    }
  }
}

/* ---------- DRAG HANDLING ---------- */
grid.addEventListener("mousedown", e => {
  if (!e.target.classList.contains("cell")) return;
  isDragging = true;
  dragValue = !roomData[username][e.target.dataset.slot];
  roomData[username][e.target.dataset.slot] = dragValue;
  save();
  draw();
});

document.addEventListener("mousemove", e => {
  if (!isDragging) return;
  const target = e.target;
  if (!target.classList.contains("cell")) return;
  const slot = target.dataset.slot;
  roomData[username][slot] = dragValue;
  save();
  draw();
});

document.addEventListener("mouseup", () => {
  isDragging = false;
});

/* ---------- TIMEZONE CHANGE ---------- */
tzSelect.onchange = () => {
  timezone = tzSelect.value;
  localStorage.setItem("timezone", timezone);
  document.getElementById("userInfo").textContent =
    `${username} (${timezone})`;
  anchorUTC = computeAnchor();
  draw();
};

/* ---------- INIT ---------- */
draw();
</script>

</body>
</html>
