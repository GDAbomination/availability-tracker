<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Availability</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0c0c0c;
  color: #eee;
  padding: 16px;
}

h1 { text-align: center; }

.controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  font-size: 14px;
}

.grid {
  display: grid;
  grid-template-columns: 70px repeat(7, 1fr);
  gap: 1px;
}

.header, .time {
  background: #151515;
  padding: 4px;
  font-size: 12px;
}

.header { text-align: center; font-weight: bold; }
.time { text-align: right; }

.cell {
  background: #1e1e1e;
  height: 22px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Team Availability</h1>

<div class="controls">
  <div id="userInfo"></div>
  <div>
    Timezone:
    <select id="tzSelect"></select>
  </div>
</div>

<div class="grid" id="grid"></div>

<script>
/* ---------------- CONSTANTS ---------------- */
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const ROWS = 48;

/* ---------------- USER ---------------- */
let username = localStorage.getItem("username");
if (!username) {
  username = prompt("Enter your name");
  localStorage.setItem("username", username);
}

let color = localStorage.getItem("color_"+username);
if (!color) {
  color = `hsl(${Math.random()*360},70%,50%)`;
  localStorage.setItem("color_"+username, color);
}

/* ---------------- TIMEZONE ---------------- */
const tzSelect = document.getElementById("tzSelect");
const timezones = Intl.supportedValuesOf("timeZone");

let timezone = localStorage.getItem("timezone") ||
  Intl.DateTimeFormat().resolvedOptions().timeZone;

timezones.forEach(tz=>{
  const opt=document.createElement("option");
  opt.value=tz;
  opt.textContent=tz;
  tzSelect.appendChild(opt);
});

tzSelect.value = timezone;

tzSelect.onchange = () => {
  timezone = tzSelect.value;
  localStorage.setItem("timezone", timezone);
  draw();
};

document.getElementById("userInfo").textContent =
  `${username} (${timezone})`;

/* ---------------- DATA ---------------- */
let data = JSON.parse(localStorage.getItem("availability_"+username)) || {};
function save() {
  localStorage.setItem("availability_"+username, JSON.stringify(data));
}

/* ---------------- GRID ---------------- */
const grid = document.getElementById("grid");
let dragging = false;
let dragValue = true;

/* headers */
grid.appendChild(document.createElement("div"));
DAYS.forEach(d=>{
  const h=document.createElement("div");
  h.textContent=d;
  h.className="header";
  grid.appendChild(h);
});

function slotToLocalLabel(slot) {
  const base = new Date(Date.UTC(2024,0,1,0,0));
  base.setUTCMinutes(slot * 30);
  return base.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
    timeZone: timezone
  });
}

function draw() {
  grid.querySelectorAll(".time,.cell").forEach(e=>e.remove());

  for (let r=0;r<ROWS;r++) {
    const t=document.createElement("div");
    t.className="time";
    t.textContent = slotToLocalLabel(r);
    grid.appendChild(t);

    for (let d=0;d<7;d++) {
      const idx = d*ROWS + r;
      const c=document.createElement("div");
      c.className="cell";

      if (data[idx]) c.style.background = color;

      c.onmousedown = () => {
        dragging = true;
        dragValue = !data[idx];
        data[idx] = dragValue;
        save();
        draw();
      };

      c.onmouseenter = () => {
        if (!dragging) return;
        data[idx] = dragValue;
        save();
        draw();
      };

      c.onmouseup = () => dragging = false;

      grid.appendChild(c);
    }
  }
}

window.onmouseup = () => dragging = false;

draw();
</script>

</body>
</html>
