<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Team Availability</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0c0c0c;
  color: #eee;
  padding: 16px;
}

h1 { text-align: center; }

.controls {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 14px;
}

.grid {
  display: grid;
  grid-template-columns: 70px repeat(7, 1fr);
  gap: 1px;
}

.header, .time {
  background: #151515;
  padding: 4px;
  font-size: 12px;
}

.header { text-align: center; font-weight: bold; }
.time { text-align: right; }

.cell {
  background: #1e1e1e;
  height: 22px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Team Availability</h1>

<div class="controls">
  <div id="userInfo"></div>
  <div>
    Share link:
    <input id="shareLink" size="28" readonly>
  </div>
</div>

<div class="grid" id="grid"></div>

<script>
/* ---------------- CONSTANTS ---------------- */
const DAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
const ROWS = 48;
const TOTAL = DAYS.length * ROWS;

/* ---------------- ROOM ---------------- */
const params = new URLSearchParams(location.search);
let room = params.get("room");
if (!room) {
  room = crypto.randomUUID().slice(0,8);
  params.set("room", room);
  history.replaceState(null,"","?"+params.toString());
}

document.getElementById("shareLink").value = location.href;

/* ---------------- USER ---------------- */
let username = localStorage.getItem("username");
if (!username) {
  username = prompt("Enter your name");
  localStorage.setItem("username", username);
}

let color = localStorage.getItem("color_"+username);
if (!color) {
  color = `hsl(${Math.random()*360},70%,50%)`;
  localStorage.setItem("color_"+username, color);
}

const timezone =
  localStorage.getItem("timezone") ||
  Intl.DateTimeFormat().resolvedOptions().timeZone;

document.getElementById("userInfo").textContent =
  `${username} (${timezone})`;

/* ---------------- DATA ---------------- */
const roomKey = "room_"+room;
let roomData = JSON.parse(localStorage.getItem(roomKey)) || {};
if (!roomData[username]) roomData[username] = {};

function save() {
  localStorage.setItem(roomKey, JSON.stringify(roomData));
}

/* ---------------- TIME MATH ---------------- */
function localSlotToUTC(day, row) {
  const local = new Date();
  local.setHours(0,0,0,0);
  local.setDate(local.getDate() + day);
  local.setMinutes(row * 30);

  return Math.floor(local.getTime() / (30*60*1000));
}

function slotLabel(row) {
  const d = new Date();
  d.setHours(0,0,0,0);
  d.setMinutes(row * 30);
  return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

/* ---------------- GRID ---------------- */
const grid = document.getElementById("grid");
let dragging = false;
let dragValue = true;

/* headers */
grid.appendChild(document.createElement("div"));
DAYS.forEach(d=>{
  const h=document.createElement("div");
  h.textContent=d;
  h.className="header";
  grid.appendChild(h);
});

function heatColor(count, max) {
  if (count === 0) return "#1e1e1e";
  const t = count / max;
  return `hsl(210, 80%, ${30 + t*30}%)`;
}

function draw() {
  grid.querySelectorAll(".time,.cell").forEach(e=>e.remove());

  const users = Object.keys(roomData);
  const maxOverlap = users.length;

  for (let r=0;r<ROWS;r++) {
    const t=document.createElement("div");
    t.className="time";
    t.textContent = slotLabel(r);
    grid.appendChild(t);

    for (let d=0;d<7;d++) {
      const utcIdx = localSlotToUTC(d, r);
      const c=document.createElement("div");
      c.className="cell";

      let overlap = 0;
      users.forEach(u=>{
        if (roomData[u][utcIdx]) overlap++;
      });

      if (roomData[username][utcIdx]) {
        c.style.background = color;
      } else {
        c.style.background = heatColor(overlap, maxOverlap);
      }

      c.onmousedown = () => {
        dragging = true;
        dragValue = !roomData[username][utcIdx];
        roomData[username][utcIdx] = dragValue;
        save();
        draw();
      };

      c.onmouseenter = () => {
        if (!dragging) return;
        roomData[username][utcIdx] = dragValue;
        save();
        draw();
      };

      c.onmouseup = () => dragging = false;

      grid.appendChild(c);
    }
  }
}

window.onmouseup = () => dragging = false;

draw();
</script>

</body>
</html>
